---
title: "AlphaDiversity"
author: "Ellie Ellis"
date: "2024-02-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Alpha diversity - diversity in a single sample
- How do we quantify diversity? Shannon Diversity Index - evenness and richness 
- ANOVA 
  - df, SS, MS, Pseudo-F, and P 
  - must meet ceratin assumptions
  - Tukey test

# Beta diversity - diversity across sampled communties, or from sample to sample
- distance matrices, pairwise comparisons of every sample
- values closer to 0 = more similar 
- Bray Curtis or weighted/unweighted Unifrac
- stress value: how difficult it was to get multi-dimensional data into 2D for analysis
  - look at git hub for appropriate stress values 
- PERMANOVA: multivariate analysis
  - don't need to meet many assumptions
  - look at p value and % of variance explained for each factor
  
# Community dispersion 
  - similarity of sample, dispersion around centroid in NMDS plot 
  - PERMDIS measures beta dispersion 
  - Do an anova on this to determine differences between treatments 




Load libraries
```{r}
library(tidyverse)
library(vegan)
install.packages("plyr")
library(plyr)
```

```{r}
asv <- read_csv("data/rarefied-table.csv")
metadata <- read_csv("data/Ellis_IowaRegen_Metadata.csv")
```


Convert table so that each row is a different sample and each column is individual asv abundances. The pivot_longer number will vary based on how many samples are in your dataframe. The first column is ASV IDs, so we will pivot to make the table longer so that it is only 3 columns (ASV, Sample, counts) and then will pivot_wider so ASV IDs are now individual columns and the first column is sample IDs.
```{r}
table <- asv %>%
  pivot_longer(2:169, names_to = "Sample", values_to = "counts") %>%  # 169 is # of columns in my table, change based on your data
  pivot_wider(names_from = ASV, values_from = counts)
```

Calculate richness for each sample. Richness is a measure of alpha diversity that calculates the number of unique features in a community. Here a feature is reprentated at the ASV level, but could be calculated for different levels such as Genus, Family, Class, etc.
```{r}
richness<-  ddply(table,~Sample,function(x) {
   data.frame(Richness=sum(x[-1]>0))
 })
```

Calculate evenness using the Pilou evenness (J). Evenness is a measure of how homogenous a community is in terms of abundance of features present. A community with a high degree of evenness is characterized by all features having equal abundance whereas communities with low evenness will be characterized by high dominance of a few features.
```{r}
evenness<- ddply(table,~Sample,function(x) {
         data.frame(Evenness=diversity(x[-1], index="simpson")/log(sum(x[-1]>0)))
 })
```


Calculate shannon diversity index (H) for each sample. Shannon diversity index is a measure of alpha diversity that takes into account both richness and evenness. Shannon index is the proportion  of individuals of one particular feature found  divided by the total number of individuals found.
```{r}
shannon <- ddply(table,~Sample,function(x) {
         data.frame(Shannon=diversity(x[-1], index="shannon"))
 })

```


Merge calculations into one table
```{r}
join <- shannon %>% 
  full_join(richness) %>% 
  full_join(evenness) %>% 
  inner_join(metadata) %>% 
  pivot_longer(2:4, names_to = "Type", values_to = "Diversity")
```

Plot tables
```{r}
plot <- ggplot(join, aes(x=Trt, y=Diversity, fill=Depth)) +
  geom_boxplot() +
  facet_wrap(~Type, scales="free")+
  theme_bw()
   
plot
```

```{r}
Pair20 <- join %>% filter(Pair_num == "20")
Pair3 <- join %>% filter(Pair_num == "03")
Pair10 <- join %>% filter(Pair_num == "10")
Pair2 <- join %>% filter(Pair_num == "02")

create_boxplots <- function(pair_data) {
  plots <- lapply(pair_data, function(pair) {
    ggplot(pair, aes(x=Depth, y=Diversity, fill=Trt)) +
      geom_boxplot() +
      facet_wrap(~Type, scales="free") +
      theme_bw()
  })
  
  return(plots)
}

pair_list <- list(Pair20, Pair3, Pair10, Pair2)
boxplot_list <- create_boxplots(pair_list)

```


Determine if alpha diversity is different between treatments/plots/etc using ANOVA (analysis of variance) and TukeyHSD post hoc test. In this example we will only go through Shannon diversity.

```{r}
alpha <- shannon %>% 
  full_join(richness) %>% 
  full_join(evenness) %>% 
  inner_join(metadata) 
```

ANOVA requires a mix of one continuous quantitative dependent variable (which corresponds to the measurements to which the question relates) and one qualitative independent variable (with at least 2 levels which will determine the groups to compare).
Assumptions:
  1. Observations are independent
  2.Sample size
      a) small sample sizes (less than 30 samples per group) must have normal distribution; if               the distribution is not normal use Kruskal-Wallis test
      b) large sample sizes (more than 30 samples per group) normal distribution is assumed
  3. Equal variance, if variance is not equal use a Welch ANOVA
  
To test for normality, we must first run the ANOVA
```{r}
res_aov <- aov(Richness ~ Trt, data = alpha)

summary(res_aov)
```

Normality can be tested in several ways both visually (histogram and QQ-plot) and more formally using a Shapiro-Wilkes test. Here we will only go over the Shapiro-Wilkes test
```{r}
shapiro.test(res_aov$residuals)
```

If the p-value is >0.05 we do not reject our hypothesis that variance is equal between species, or in other words our assumption of equal variance is met.

Homogeneity of variance can be assessed visually (using a boxplot or dotplot) or can be done with Levene’s or Bartlett’s test. We will go over Levene's test here.
```{r}
library(car)

leveneTest(Shannon ~ Field_ID, data = alpha)
```
If the p-value is >0.05 we do not reject our hypothesis that residuals follow a normal distribution, or in other words, our assumption of normality is met.


To look at results from the ANOVA
```{r}
res_aov <- aov(Evenness ~ Field_ID*Depth, data = alpha)

summary(res_aov)
```


If the p-value is smaller than 0.05, at least one site has a different shannon diversity than the others, but to determine which sites are different from each other we have to do post-hoc analysis. Here we will use a Tukey HSD to compare all groups to each other
```{r}
tukey<-TukeyHSD(res_aov)

tukey
```


If normality is not met, to run a Kruskal-Wallis test
```{r}
kw_test <- kruskal.test(Richness ~ Trt, data = alpha)
kw_test
```

We will use a pairwise wilcox test for the posthoc analysis to determine which sites are different from each other.
```{r}
pairwise.wilcox.test(alpha$Richness, alpha$Site,
                 p.adjust.method = "BH")
```


